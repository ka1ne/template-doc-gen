name: Database Migration Steps
description: A set of steps for safely performing database migrations with validation and rollback capability
type: stepgroup
author: Database Team
version: 1.3.2
tags:
  - database
  - migration
  - schema

variables:
  dbConnectionString:
    type: string
    description: Database connection string
    required: true
  migrationScriptsPath:
    type: string
    description: Path to migration scripts
    required: true
  backupLocation:
    type: string
    description: Location to store database backups
    required: false

parameters:
  performBackup:
    type: boolean
    description: Create a backup before migration
    default: true
    required: false
  validateAfterMigration:
    type: boolean
    description: Run validation queries after migration
    default: true
    required: false
  autoRollback:
    type: boolean
    description: Automatically rollback on failure
    default: true
    required: false
  lockTimeout:
    type: number
    description: Database lock timeout in seconds
    default: 300
    required: false

steps:
  - name: Validate Migration Scripts
    description: Check migration scripts for syntax errors
  - name: Create Database Backup
    description: Create a backup of the database before migration
  - name: Acquire Database Lock
    description: Acquire lock to prevent concurrent migrations
  - name: Execute Migration Scripts
    description: Run the migration scripts against the database
  - name: Validate Migration
    description: Run validation queries to ensure migration success
  - name: Release Database Lock
    description: Release the database lock

examples:
  - |
    # Example usage in a stage
    steps:
      - stepGroup:
          template:
            name: Database Migration Steps
            identifier: database_migration_steps
            versionLabel: 1.3.2
          variables:
            dbConnectionString: ${secrets.getValue("db_connection")}
            migrationScriptsPath: migrations/
            backupLocation: s3://backups/db/
          parameters:
            performBackup: true
            validateAfterMigration: true
            autoRollback: true
            lockTimeout: 600
